<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <title>Firefly – Podgląd Pliku</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.11"></script>

</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto bg-white p-6 rounded shadow space-y-6">
        <h1 class="text-2xl font-bold">Podgląd pliku CSV</h1>

        <div id="fileContainer" class="text-gray-700">
            Ładowanie pliku...
        </div>
    </div>

    <script>
        // Pobieramy ID z URL (/file/{id})
        const fileId = window.location.pathname.split("/").pop();

        // Pobieramy dane JSON z backendu i ładujemy do #fileContainer
        htmx.ajax("GET", `/api/file/${fileId}`, "#fileContainer");

        // Render JSON → tabela HTML
        document.body.addEventListener("htmx:afterOnLoad", function(evt) {
            const target = evt.detail.target.id;
            const response = evt.detail.xhr.responseText;

            let data;
            try { data = JSON.parse(response); }
            catch { return; }

            if (!data.content || target !== "fileContainer") return;

            const rows = data.content;

            let html = `
                <h2 class="text-xl font-bold mb-2">CSV (${rows.length} rekordów)</h2>

                <table class="min-w-full border">
                    <thead>
                        <tr>
                            ${Object.keys(rows[0]).map(h => `<th class='border px-2 py-1'>${h}</th>`).join("")}
                        </tr>
                    </thead>
                    <tbody>
                        ${rows.map(r => `
                            <tr class="hover:bg-gray-50">
                                ${Object.values(r).map(v => `<td class='border px-2 py-1'>${v}</td>`).join("")}
                            </tr>
                        `).join("")}
                    </tbody>
                </table>

                <div class="mt-4">
                    <a href="/file/do-match/${fileId}"
                       hx-get="/api/file/do-match/${fileId}"
                       hx-target="#fileContainer"
                       class="bg-blue-600 text-white px-4 py-2 rounded inline-block">
                        Matchuj transakcje
                    </a>
                </div>
            `;

            document.querySelector("#fileContainer").innerHTML = html;
        });
    </script>
</body>
</html>
